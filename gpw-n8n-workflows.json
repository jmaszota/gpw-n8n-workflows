{
  "name": "gpw-n8n-workflows",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        0,
        -32
      ],
      "id": "cd5864dd-8277-4205-8880-eda52d46a54f",
      "name": "When clicking ‚ÄòExecute workflow‚Äô"
    },
    {
      "parameters": {
        "url": "https://www.bankier.pl/rss/espi.xml",
        "options": {}
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        224,
        -128
      ],
      "id": "2ae89f2b-0015-4661-afde-fa509eaec6f2",
      "name": "RSS Feed: Bankier ESPI"
    },
    {
      "parameters": {
        "url": "https://www.bankier.pl/rss/gielda.xml",
        "options": {
          "customFields": ""
        }
      },
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1.2,
      "position": [
        224,
        64
      ],
      "id": "ad6ac53f-3ea7-41ce-8fa6-997e25f05743",
      "name": "RSS Feed: Bankier Gie≈Çda"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        448,
        -32
      ],
      "id": "558079a9-4c4d-45ea-b908-b52cbeba0762",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Pobierz oryginalnƒÖ listƒô news√≥w\nconst input = $input.first().json;\nconst claudeRaw = input.claudeResponse;\nconst origItems = input.originalItems;\n\n// Pobierz analizƒô Claude\nlet analysis = [];\n\ntry {\n  // Claude zwraca content jako tablicƒô ‚Äî wyciƒÖgamy tekst\n  const rawText = claudeRaw.content?.[0]?.text || '[]';\n  // Usu≈Ñ ewentualne backticki gdyby Claude jednak doda≈Ç markdown\n  const cleaned = rawText.replace(/```json|```/g, '').trim();\n  analysis = JSON.parse(cleaned);\n} catch(e) {\n  // Je≈õli parsowanie padnie ‚Äî kontynuuj bez sentymentu\n  analysis = [];\n}\n\n// Stw√≥rz mapƒô: id ‚Üí analiza (id w Claude zaczyna siƒô od 1)\nconst analysisMap = {};\nfor (const a of analysis) {\n  analysisMap[a.id] = a;\n}\n\n// Sta≈Çe wizualne\nconst sentimentIcon = { BULLISH: 'üìà', BEARISH: 'üìâ', NEUTRAL: '‚û°Ô∏è' };\nconst importanceDot = { HIGH: 'üî¥', MEDIUM: 'üü°', LOW: '‚ö™' };\nconst tickerColor   = '#2980b9';\n\n// Podziel na kategorie\nconst highItems  = origItems.filter((_, i) => analysisMap[i+1]?.importance === 'HIGH');\nconst spolkiRest = origItems.filter((item, i) => \n  item._category === 'SPOLKA' && analysisMap[i+1]?.importance !== 'HIGH'\n);\nconst makroItems = origItems.filter((item, i) => \n  item._category === 'MAKRO' && analysisMap[i+1]?.importance !== 'HIGH'\n);\n\nconst renderRow = (item, idx) => {\n  const a       = analysisMap[idx + 1] || {};\n  const date    = item.pubDate\n    ? new Date(item.pubDate).toLocaleString('pl-PL', {\n        day: '2-digit', month: '2-digit',\n        hour: '2-digit', minute: '2-digit'\n      })\n    : '';\n  const ticker  = item._ticker || '';\n  const title   = item.title || '';\n  const link    = item.link || '#';\n  const icon    = sentimentIcon[a.sentiment] || '‚û°Ô∏è';\n  const dot     = importanceDot[a.importance] || '‚ö™';\n  const reason  = a.reason || '';\n\n  return `<tr style=\"border-bottom:1px solid #f0f0f0;\">\n    <td style=\"padding:6px 8px; color:#999; font-size:11px; white-space:nowrap; vertical-align:top;\">${date}</td>\n    <td style=\"padding:6px 8px; vertical-align:top;\">\n      <span style=\"background:${tickerColor}; color:white; border-radius:3px; padding:1px 5px; font-size:11px; margin-right:4px;\">${ticker}</span>\n      ${icon} ${dot}\n      <a href=\"${link}\" style=\"color:#2c3e50; text-decoration:none; font-weight:500;\">${title}</a>\n      ${reason ? `<br><span style=\"color:#888; font-size:12px; margin-left:4px;\">‚Ü≥ ${reason}</span>` : ''}\n    </td>\n  </tr>`;\n};\n\n// Zlicz statystyki\nconst bullish = analysis.filter(a => a.sentiment === 'BULLISH').length;\nconst bearish = analysis.filter(a => a.sentiment === 'BEARISH').length;\nconst high    = analysis.filter(a => a.importance === 'HIGH').length;\n\nconst html = `\n<html><body style=\"font-family:Arial,sans-serif; max-width:720px; margin:auto; color:#333;\">\n\n<h2 style=\"border-bottom:2px solid #2980b9; padding-bottom:8px;\">\n  üìä Raport GPW ‚Äî ${new Date().toLocaleDateString('pl-PL', {\n    weekday:'long', day:'numeric', month:'long'\n  })}\n</h2>\n\n<div style=\"background:#f8f9fa; border-radius:6px; padding:10px 14px; margin-bottom:16px; font-size:13px;\">\n  üìà Bullish: <strong>${bullish}</strong> &nbsp;|&nbsp;\n  üìâ Bearish: <strong>${bearish}</strong> &nbsp;|&nbsp;\n  üî¥ Wa≈ºne: <strong>${high}</strong> &nbsp;|&nbsp;\n  ≈ÅƒÖcznie: <strong>${origItems.length}</strong> news√≥w\n</div>\n\n${highItems.length > 0 ? `\n<h3 style=\"color:#c0392b;\">üî¥ Wysokie znaczenie ‚Äî mo≈ºliwy wp≈Çyw na kurs</h3>\n<table style=\"width:100%; border-collapse:collapse;\">\n  <tbody>${highItems.map((item) => renderRow(item, origItems.indexOf(item))).join('')}</tbody>\n</table>\n` : ''}\n\n${spolkiRest.length > 0 ? `\n<h3 style=\"color:#2c3e50; margin-top:20px;\">üè¢ Twoje sp√≥≈Çki</h3>\n<table style=\"width:100%; border-collapse:collapse;\">\n  <tbody>${spolkiRest.map((item) => renderRow(item, origItems.indexOf(item))).join('')}</tbody>\n</table>\n` : ''}\n\n${makroItems.length > 0 ? `\n<h3 style=\"color:#7f8c8d; margin-top:20px;\">üåç Makroekonomia</h3>\n<table style=\"width:100%; border-collapse:collapse;\">\n  <tbody>${makroItems.map((item) => renderRow(item, origItems.indexOf(item))).join('')}</tbody>\n</table>\n` : ''}\n\n<hr style=\"margin-top:24px;\">\n<p style=\"color:#bbb; font-size:11px;\">\n  n8n GPW Agent v3.0 | Analiza: Claude Haiku | ≈πr√≥d≈Ça: Bankier ESPI + Gie≈Çda\n</p>\n</body></html>\n`;\n\nreturn [{ json: { \n  html, \n  count: origItems.length, \n  high, \n  bullish, \n  bearish \n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        -32
      ],
      "id": "2c9b17d0-eab4-4c9d-b889-d5a99d76788c",
      "name": "Formatowanie dla emaila"
    },
    {
      "parameters": {
        "sendTo": "jacek.maszota@gmail.com",
        "subject": "=üìä GPW [üî¥{{ $json.high }} üìà{{ $json.bullish }} üìâ{{ $json.bearish }}] - {{ $now.format('dd.MM HH:mm') }}",
        "message": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.2,
      "position": [
        1792,
        -32
      ],
      "id": "255f3a49-ab37-4311-8358-217a8741369e",
      "name": "Send a message",
      "webhookId": "477c7504-c9cf-4e05-ab71-1f4dd2483321",
      "credentials": {
        "gmailOAuth2": {
          "id": "FDzHFgkF7UtF1zFW",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// TWOJE PORTFOLIO ‚Äî dostosuj nazwy do swoich sp√≥≈Çek\n// Ka≈ºda sp√≥≈Çka ma listƒô s≈Ç√≥w kluczowych kt√≥re\n// mogƒÖ pojawiƒá siƒô w tytule newsa\n// ============================================\nconst PORTFOLIO = [\n  { ticker: 'ICE',  keywords: ['Medinice', 'ICE', 'medinice'] },\n  { ticker: 'OPL',  keywords: ['Orange Polska', 'Orange PL', 'OPL'] },\n  { ticker: 'PKN',  keywords: ['PKN', 'Orlen', 'ORLEN', 'PKN ORLEN'] },\n  { ticker: 'KGH',  keywords: ['KGHM', 'KGH', 'Polska Mied≈∫'] },\n  { ticker: 'JSW',  keywords: ['JSW', 'Jastrzƒôbska', 'Jastrzebska'] },\n  // Dodaj pozosta≈Çe sp√≥≈Çki z Twojego portfolio:\n  { ticker: 'LBW',  keywords: ['Lubawa', 'LBW'] },\n  { ticker: 'MLR',  keywords: ['Molecure', 'MLR'] },\n  { ticker: 'ENA',  keywords: ['Enea', 'ENA'] },\n  { ticker: 'PGE',  keywords: ['PGE'] },\n  { ticker: 'TRK',  keywords: ['Trakcja', 'TRK'] },\n  { ticker: 'DVL',  keywords: ['Develia', 'DVL'] },\n  { ticker: 'CPT',  keywords: ['Captor', 'CPT'] },\n  { ticker: 'ALR',  keywords: ['Alior', 'ALR'] },\n  { ticker: 'CRE',  keywords: ['Creotech', 'CRE'] },\n  { ticker: 'PZU',  keywords: ['PZU'] },\n  { ticker: 'ATT',  keywords: ['Azoty', 'ATT', 'Grupa Azoty'] },\n];\n\n// ============================================\n// MAKRO ‚Äî newsy kt√≥re zawsze przepuszczamy\n// niezale≈ºnie od sp√≥≈Çki\n// ============================================\nconst MAKRO_KEYWORDS = [\n  'RPP', 'stopy procentowe', 'stopa procentowa',\n  'inflacja', 'CPI', 'GUS', 'NBP',\n  'Fed', 'Federal Reserve', 'EBC', 'ECB',\n  'PKB', 'GDP', 'bezrobocie',\n  'c≈Ça', 'taryfy', 'Trump',\n  'recesja', 'stagflacja',\n  'WIG20', 'WIG', 'GPW sesja',\n];\n\n// ============================================\n// LOGIKA FILTROWANIA\n// ============================================\nconst items = $input.all();\nconst result = [];\n\nfor (const item of items) {\n  const title = (item.json.title || '').toLowerCase();\n  const desc  = (item.json.content || item.json.description || '').toLowerCase();\n  const text  = title + ' ' + desc;\n\n  // Sprawd≈∫ czy news dotyczy sp√≥≈Çki z portfolio\n  let matchedTicker = null;\n  for (const stock of PORTFOLIO) {\n    if (stock.keywords.some(kw => text.includes(kw.toLowerCase()))) {\n      matchedTicker = stock.ticker;\n      break;\n    }\n  }\n\n  // Sprawd≈∫ czy to news makro\n  const isMakro = MAKRO_KEYWORDS.some(kw => text.includes(kw.toLowerCase()));\n\n  // Przepu≈õƒá tylko je≈õli pasuje do sp√≥≈Çki LUB jest makro\n  if (matchedTicker || isMakro) {\n    result.push({\n      json: {\n        ...item.json,\n        _ticker: matchedTicker || 'MAKRO',\n        _category: matchedTicker ? 'SPOLKA' : 'MAKRO',\n      }\n    });\n  }\n}\n\n// Posortuj: najpierw sp√≥≈Çki, potem makro\nresult.sort((a, b) => {\n  if (a.json._category === b.json._category) return 0;\n  return a.json._category === 'SPOLKA' ? -1 : 1;\n});\n\nreturn result;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -32
      ],
      "id": "79599397-3b55-4698-b1fa-d8e57834d1e4",
      "name": "Filtr sp√≥≈Çek i makro"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\n// Zbuduj listƒô news√≥w jako tekst dla Claude\nconst newsText = items.map((item, i) => {\n  const ticker   = item.json._ticker || 'MAKRO';\n  const category = item.json._category || 'MAKRO';\n  const title    = item.json.title || '';\n  const desc     = item.json.content || item.json.description || '';\n  // Ucinamy opis do 200 znak√≥w ≈ºeby nie przepalaƒá token√≥w\n  const shortDesc = desc.replace(/<[^>]*>/g, '').substring(0, 200);\n\n  return `${i + 1}. [${ticker}] ${title}${shortDesc ? '\\n   ' + shortDesc : ''}`;\n}).join('\\n\\n');\n\n// Zbuduj gotowy obiekt requestu dla Claude\nconst requestBody = {\n  model: \"claude-haiku-4-5-20251001\",\n  max_tokens: 2000,\n  system: \"Jeste≈õ analitykiem rynku GPW i makroekonomii. Analizujesz newsy pod kƒÖtem wp≈Çywu na kursy akcji polskich sp√≥≈Çek. Odpowiadasz WY≈ÅƒÑCZNIE w formacie JSON ‚Äî bez ≈ºadnego tekstu przed ani po JSON. Bez markdown, bez komentarzy.\",\n  messages: [\n    {\n      role: \"user\",\n      content: `Przeanalizuj poni≈ºsze newsy gie≈Çdowe. Dla ka≈ºdego zwr√≥ƒá obiekt JSON z polami:\\n- id: numer newsa (liczba)\\n- sentiment: BULLISH / BEARISH / NEUTRAL\\n- importance: HIGH / MEDIUM / LOW\\n- reason: max 15 s≈Ç√≥w po polsku ‚Äî dlaczego taki wp≈Çyw na kurs\\n\\nKryterium importance:\\n- HIGH: wyniki finansowe, du≈ºe kontrakty, zmiana zarzƒÖdu, postƒôpowania regulacyjne, decyzje RPP\\n- MEDIUM: mniejsze kontrakty, prognozy analityk√≥w, dane makro\\n- LOW: formalne komunikaty, transakcje insider√≥w na ma≈ÇƒÖ skalƒô, WZA\\n\\nOdpowiedz TYLKO tablicƒÖ JSON, np.:\\n[{\"id\":1,\"sentiment\":\"BULLISH\",\"importance\":\"HIGH\",\"reason\":\"Wyniki znacznie powy≈ºej oczekiwa≈Ñ rynku\"}]\\n\\nNewsy do analizy:\\n${newsText}`\n    }\n  ]\n};\n// Zapisz originalItems w Static Data ≈ºeby by≈Çy dostƒôpne po HTTP Request\nconst staticData = $getWorkflowStaticData('global');\nstaticData.originalItems = items.map(i => i.json);\n\n// Zwr√≥ƒá jeden item z ca≈Çym tekstem + oryginalnƒÖ listƒÖ news√≥w\nreturn [{\n  json: {\n    newsText,\n    requestBody,\n    originalItems: items.map(i => i.json),\n    count: items.length\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        -32
      ],
      "id": "4431c755-e47d-4ff6-b438-da7ba53462a7",
      "name": "Przygotuj prompt"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-api-key",
              "value": "API_KEY"
            },
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "content-type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{JSON.stringify({\n  \"model\": \"claude-haiku-4-5-20251001\",\n  \"max_tokens\": 2000,\n  \"system\": \"Jeste≈õ analitykiem rynku GPW. Odpowiadasz WY≈ÅƒÑCZNIE tablicƒÖ JSON bez tekstu przed ani po. Ka≈ºdy element: {id, sentiment: BULLISH/BEARISH/NEUTRAL, importance: HIGH/MEDIUM/LOW, reason: max 15 s≈Ç√≥w po polsku}.\",\n  \"messages\": [{\"role\": \"user\", \"content\": $json.newsText}]\n})}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.4,
      "position": [
        1120,
        -32
      ],
      "id": "2d4f7073-3c5d-425a-8ecd-c2b6e8322afa",
      "name": "HTTP Request: Claude API",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Dane z Claude (poprzedni node)\nconst claudeResponse = $input.first().json;\n\n// originalItems przekazane przez HTTP Request nie sƒÖ dostƒôpne\n// Dlatego rekonstruujemy je z danych kt√≥re HTTP Request otrzyma≈Ç\n// poprzez zapisanie ich w Static Data w Code: Przygotuj prompt\n\nconst stored = $getWorkflowStaticData('global');\nconst originalItems = stored.originalItems || [];\n\nreturn [{\n  json: {\n    claudeResponse,\n    originalItems\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        -32
      ],
      "id": "a24814c7-8734-4cbd-8c0e-bb1be37b9f32",
      "name": "Scala wyniki"
    }
  ],
  "pinData": {},
  "connections": {
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "RSS Feed: Bankier ESPI",
            "type": "main",
            "index": 0
          },
          {
            "node": "RSS Feed: Bankier Gie≈Çda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSS Feed: Bankier ESPI": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RSS Feed: Bankier Gie≈Çda": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Filtr sp√≥≈Çek i makro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatowanie dla emaila": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtr sp√≥≈Çek i makro": {
      "main": [
        [
          {
            "node": "Przygotuj prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Przygotuj prompt": {
      "main": [
        [
          {
            "node": "HTTP Request: Claude API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request: Claude API": {
      "main": [
        [
          {
            "node": "Scala wyniki",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scala wyniki": {
      "main": [
        [
          {
            "node": "Formatowanie dla emaila",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "ba1ea9dd-dbfe-495e-a87b-fde338f1abc8",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "aa47a6072b31783d110737f20a24e70688ccc8dc522cf419aa8d709d2bd88407"
  },
  "id": "fEHsQelHIxiXw5eB",
  "tags": []
}